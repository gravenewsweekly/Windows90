<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Windows 90s Productivity Challenge</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Ÿ</text></svg>">
    <style>
        /* Microsoft Windows 1990s Theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "MS Sans Serif", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        body {
            background-color: #008080;
            color: #000;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* Main Container - Windows 95 Window Style */
        .window {
            width: 95%;
            max-width: 500px;
            background-color: #c0c0c0;
            border: 2px solid;
            border-color: #dfdfdf #000 #000 #dfdfdf;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.3);
            margin: 10px auto;
            display: none;
            position: relative;
        }
        
        .window.active {
            display: block;
            animation: windowAppear 0.3s ease-out;
        }
        
        @keyframes windowAppear {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Window Title Bar */
        .title-bar {
            background: linear-gradient(90deg, #000080, #1084d0);
            color: white;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            height: 30px;
            cursor: move;
        }
        
        .title-bar-controls {
            display: flex;
            gap: 4px;
        }
        
        .title-bar-button {
            width: 20px;
            height: 18px;
            background-color: #c0c0c0;
            border: 1px solid;
            border-color: #dfdfdf #000 #000 #dfdfdf;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .title-bar-button:active {
            border-color: #000 #dfdfdf #dfdfdf #000;
            transform: translate(1px, 1px);
        }
        
        /* Window Content */
        .window-body {
            padding: 15px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Menu Bar */
        .menu-bar {
            display: flex;
            background-color: #c0c0c0;
            border-bottom: 1px solid #808080;
            font-size: 13px;
        }
        
        .menu-item {
            padding: 4px 12px;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
        }
        
        .menu-item:hover {
            border-color: #dfdfdf #000 #000 #dfdfdf;
        }
        
        .menu-item.active {
            background-color: #000080;
            color: white;
        }
        
        /* Game Elements */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 15px 0;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            background-color: #c0c0c0;
            padding: 10px;
            border: 2px inset;
            font-size: 14px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-area {
            width: 100%;
            height: 300px;
            background-color: #000;
            border: 4px inset #808080;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        
        .task {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #008080;
            border: 3px outset #00c0c0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, opacity 0.3s;
            z-index: 10;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .task:hover, .task:active {
            transform: scale(1.05);
            border-color: #00ffff;
        }
        
        .task.completed {
            background-color: #00c000;
            border-color: #00ff00;
            animation: taskComplete 0.5s ease-out;
        }
        
        .task.failed {
            background-color: #c00000;
            border-color: #ff0000;
            animation: taskFail 0.5s ease-out;
        }
        
        @keyframes taskComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(0); opacity: 0; }
        }
        
        @keyframes taskFail {
            0% { transform: scale(1); }
            50% { transform: scale(0.8); }
            100% { transform: scale(0); opacity: 0; }
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #808080;
            border: 2px inset;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #000080;
            width: 100%;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Buttons in Windows 95 Style */
        button {
            background-color: #c0c0c0;
            border: 2px solid;
            border-color: #dfdfdf #000 #000 #dfdfdf;
            padding: 8px 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            min-height: 32px;
            min-width: 90px;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
        }
        
        button:active {
            border-color: #000 #dfdfdf #dfdfdf #000;
            transform: translate(1px, 1px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.primary {
            background-color: #000080;
            color: white;
        }
        
        /* Form Elements */
        input, textarea, select {
            background-color: white;
            border: 2px inset #808080;
            padding: 8px;
            font-size: 14px;
            width: 100%;
            font-family: inherit;
        }
        
        /* Content Pages */
        .content-page {
            padding: 15px;
            background-color: #fff;
            border: 2px inset #808080;
            height: 300px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
            scrollbar-width: thin;
            scrollbar-color: #c0c0c0 #fff;
        }
        
        .content-page::-webkit-scrollbar {
            width: 16px;
        }
        
        .content-page::-webkit-scrollbar-track {
            background: #fff;
        }
        
        .content-page::-webkit-scrollbar-thumb {
            background-color: #c0c0c0;
            border: 2px inset #808080;
        }
        
        .content-page h2 {
            color: #000080;
            margin-bottom: 10px;
            font-size: 18px;
            border-bottom: 1px solid #c0c0c0;
            padding-bottom: 5px;
        }
        
        .content-page p {
            margin-bottom: 12px;
        }
        
        .content-page ul, .content-page ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }
        
        /* Game Over Screen */
        .game-over {
            text-align: center;
            padding: 30px 20px;
        }
        
        .game-over h2 {
            color: #c00000;
            font-size: 24px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 #000;
        }
        
        .score-display {
            font-size: 36px;
            font-weight: bold;
            color: #000080;
            margin: 15px 0;
            text-shadow: 1px 1px 0 #fff;
        }
        
        /* Footer */
        .footer {
            margin-top: 20px;
            color: white;
            text-align: center;
            font-size: 12px;
            padding: 10px;
            opacity: 0.8;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                justify-content: flex-start;
                padding-top: 20px;
            }
            
            .window {
                width: 100%;
                margin: 5px auto;
                max-width: 100%;
            }
            
            .game-area {
                height: 250px;
            }
            
            .task {
                width: 55px;
                height: 55px;
                font-size: 14px;
            }
            
            button {
                min-width: 80px;
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
                gap: 5px;
                font-size: 13px;
            }
            
            .content-page {
                height: 250px;
            }
        }
        
        /* High Score Table */
        .high-scores {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .high-scores th {
            background-color: #000080;
            color: white;
            padding: 8px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        .high-scores td {
            padding: 8px;
            border-bottom: 1px solid #c0c0c0;
        }
        
        .high-scores tr:nth-child(even) {
            background-color: #e0e0e0;
        }
        
        .high-scores tr:hover {
            background-color: #d0d0d0;
        }
        
        /* Instructions */
        .instructions {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 15px;
            background-color: #fff;
            padding: 15px;
            border: 2px inset #808080;
        }
        
        /* Hidden Class */
        .hidden {
            display: none !important;
        }
        
        /* Game Controls */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #c0c0c0;
            border: 2px solid #000;
            padding: 10px 20px;
            z-index: 1000;
            font-weight: bold;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .notification.show {
            display: block;
            animation: notificationSlide 0.3s ease-out;
        }
        
        @keyframes notificationSlide {
            from {
                top: -50px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }
        
        /* Level Up Animation */
        .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffff00;
            text-shadow: 3px 3px 0 #000;
            z-index: 100;
            animation: levelUpAnim 1s ease-out;
            display: none;
        }
        
        @keyframes levelUpAnim {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #008080;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s;
        }
        
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #c0c0c0;
            border-top: 5px solid #000080;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Performance warning */
        .performance-warning {
            background-color: #c00000;
            color: white;
            padding: 5px 10px;
            font-size: 11px;
            text-align: center;
            border: 1px solid #fff;
            margin-bottom: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div style="color: white; font-size: 18px; margin-top: 20px;">Loading Windows 90s...</div>
    </div>
    
    <!-- Performance Warning -->
    <div id="performance-warning" class="performance-warning">
        Warning: High task count may affect performance on some devices
    </div>
    
    <!-- Notification Area -->
    <div id="notification" class="notification"></div>
    
    <!-- Level Up Animation -->
    <div id="level-up-anim" class="level-up">LEVEL UP!</div>
    
    <!-- Main Menu Window -->
    <div id="main-menu" class="window active">
        <div class="title-bar">
            <div class="title-bar-text">ðŸ“Ÿ Windows 90s Productivity Challenge</div>
            <div class="title-bar-controls">
                <button class="title-bar-button" aria-label="Minimize">_</button>
                <button class="title-bar-button" aria-label="Maximize">â–¡</button>
                <button class="title-bar-button" aria-label="Close">Ã—</button>
            </div>
        </div>
        
        <div class="menu-bar">
            <div class="menu-item active" onclick="showWindow('main-menu')">Home</div>
            <div class="menu-item" onclick="showWindow('game')">Game</div>
            <div class="menu-item" onclick="showWindow('high-scores')">High Scores</div>
            <div class="menu-item" onclick="showWindow('about')">About</div>
        </div>
        
        <div class="window-body">
            <div class="game-container">
                <h1 style="color: #000080; text-align: center; font-size: 24px;">Windows 90s Productivity Challenge</h1>
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 60px; color: #008080;">ðŸ“Ÿ</div>
                    <p style="margin: 15px 0; font-size: 16px;">Complete tasks before they expire! Each level gets harder!</p>
                </div>
                
                <div class="instructions">
                    <p><strong>How to play:</strong></p>
                    <p>âœ“ Click on tasks before they disappear</p>
                    <p>âœ“ Complete tasks to earn points</p>
                    <p>âœ“ Each level has more tasks and less time</p>
                    <p>âœ“ Miss 3 tasks and the game ends</p>
                    <p style="margin-top: 10px; color: #000080; font-weight: bold;">Best Score: <span id="best-score-display">0</span></p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 15px; width: 100%;">
                    <button class="primary" onclick="startGame()">Start Game</button>
                    <button onclick="showWindow('instructions')">How to Play</button>
                    <button onclick="showWindow('high-scores')">View High Scores</button>
                    <button onclick="showWindow('settings')">Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Window -->
    <div id="game" class="window">
        <div class="title-bar">
            <div class="title-bar-text">Productivity Challenge - Level <span id="level-display">1</span></div>
            <div class="title-bar-controls">
                <button class="title-bar-button" onclick="showWindow('main-menu')">Ã—</button>
            </div>
        </div>
        
        <div class="window-body">
            <div class="stats-bar">
                <div class="stat-item">
                    <span>Score:</span>
                    <span id="score">0</span>
                </div>
                <div class="stat-item">
                    <span>Level:</span>
                    <span id="level">1</span>
                </div>
                <div class="stat-item">
                    <span>Lives:</span>
                    <span id="lives">3</span>
                </div>
                <div class="stat-item">
                    <span>Tasks:</span>
                    <span id="tasks-completed">0</span>/<span id="tasks-total">5</span>
                </div>
            </div>
            
            <div class="progress-bar">
                <div id="time-progress" class="progress-fill" style="width: 100%"></div>
            </div>
            
            <div id="game-area" class="game-area">
                <!-- Tasks will be generated here -->
            </div>
            
            <div class="controls">
                <button onclick="pauseGame()" id="pause-btn">Pause</button>
                <button onclick="showWindow('main-menu')">Main Menu</button>
                <button onclick="resetGame()">Restart</button>
            </div>
        </div>
    </div>
    
    <!-- Game Over Window -->
    <div id="game-over" class="window">
        <div class="title-bar">
            <div class="title-bar-text">Game Over</div>
            <div class="title-bar-controls">
                <button class="title-bar-button" onclick="showWindow('main-menu')">Ã—</button>
            </div>
        </div>
        
        <div class="window-body">
            <div class="game-over">
                <h2>GAME OVER</h2>
                <div style="font-size: 60px; color: #c00000; margin: 20px 0;">ðŸ’€</div>
                <p>Your productivity has crashed!</p>
                
                <div class="score-display">
                    <span id="final-score">0</span>
                </div>
                
                <p>Level reached: <span id="final-level">1</span></p>
                
                <div style="margin: 20px 0;">
                    <input type="text" id="player-name" placeholder="Enter your name (max 20 chars)" maxlength="20" style="margin-bottom: 15px;">
                    <div class="controls">
                        <button class="primary" onclick="saveScore()">Save Score</button>
                        <button onclick="startGame()">Play Again</button>
                        <button onclick="showWindow('main-menu')">Main Menu</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- High Scores Window -->
    <div id="high-scores" class="window">
        <div class="title-bar">
            <div class="title-bar-text">High Scores</div>
            <div class="title-bar-controls">
                <button class="title-bar-button" onclick="showWindow('main-menu')">Ã—</button>
            </div>
        </div>
        
        <div class="window-body">
            <div class="content-page">
                <h2>Productivity Hall of Fame</h2>
                <table class="high-scores">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Level</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="high-scores-body">
                        <!-- High scores will be loaded here -->
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="clearScores()">Clear Scores</button>
                    <button onclick="showWindow('main-menu')">Back to Menu</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instructions Window -->
    <div id="instructions" class="window">
        <div class="title-bar">
            <div class="title-bar-text">How to Play</div>
            <div class="title-bar-controls">
                <button class="title-bar-button" onclick="showWindow('main-menu')">Ã—</button>
            </div>
        </div>
        
        <div class="window-body">
            <div class="content-page">
                <h2>Windows 90s Productivity Challenge</h2>
                <p>Welcome to the ultimate productivity test from the 1990s!</p>
                
                <h3>Game Objective</h3>
                <p>Complete as many tasks as possible before they expire. Each level increases in difficulty with more tasks and less time.</p>
                
                <h3>Gameplay</h3>
                <ol>
                    <li>Tasks appear as colored boxes in the game area</li>
                    <li>Click on tasks before they disappear</li>
                    <li>Each completed task gives you points</li>
                    <li>Each missed task costs you one life</li>
                    <li>Complete all tasks in a level to advance</li>
                </ol>
                
                <h3>Scoring</h3>
                <ul>
                    <li>Each task: 10 points Ã— level</li>
                    <li>Time bonus: remaining seconds Ã— level</li>
                    <li>Level completion: 100 points Ã— level</li>
                </ul>
                
                <h3>Difficulty</h3>
                <p>The game gets progressively harder:
                <br>â€¢ More tasks per level
                <br>â€¢ Less time to complete tasks
                <br>â€¢ Tasks appear for shorter durations</p>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="primary" onclick="startGame()">Start Playing</button>
                    <button onclick="showWindow('main-menu')">Back to Menu</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Window -->
    <div id="settings" class="window">
        <div class="title-bar">
            <div class="title-bar-text">Settings</div>
            <div class="title-bar-controls">
                <button class="title-bar-button" onclick="showWindow('main-menu')">Ã—</button>
            </div>
        </div>
        
        <div class="window-body">
            <div class="content-page">
                <h2>Game Settings</h2>
                
                <div style="margin-bottom: 15px;">
                    <label for="difficulty">Difficulty:</label>
                    <select id="difficulty" style="width: 100%; margin-top: 5px;">
                        <option value="easy">Easy (Recommended for beginners)</option>
                        <option value="normal" selected>Normal (Balanced challenge)</option>
                        <option value="hard">Hard (For productivity experts)</option>
                        <option value="insane">Insane (Nearly impossible)</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="sound">Sound Effects:</label>
                    <select id="sound" style="width: 100%; margin-top: 5px;">
                        <option value="on" selected>On</option>
                        <option value="off">Off</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="theme">Visual Theme:</label>
                    <select id="theme" style="width: 100%; margin-top: 5px;">
                        <option value="windows95" selected>Windows 95</option>
                        <option value="windows31">Windows 3.1</option>
                        <option value="classic">Classic Monochrome</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="checkbox" id="performance-mode">
                        Performance Mode (Reduces animations)
                    </label>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="primary" onclick="saveSettings()">Save Settings</button>
                    <button onclick="showWindow('main-menu')">Cancel</button>
                    <button onclick="resetToDefaults()" style="margin-top: 10px;">Reset to Defaults</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- About Window -->
    <div id="about" class="window">
        <div class="title-bar">
            <div class="title-bar-text">About</div>
            <div class="title-bar-controls">
                <button class="title-bar-button" onclick="showWindow('main-menu')">Ã—</button>
            </div>
        </div>
        
        <div class="window-body">
            <div class="content-page">
                <h2>About Windows 90s Productivity Challenge</h2>
                <p>This game is a tribute to the classic Microsoft Windows experience of the 1990s, reimagined as a challenging productivity game.</p>
                
                <h3>Game Concept</h3>
                <p>Experience the thrill of managing multiple tasks before deadlines, just like in a real 1990s office environment. The game tests your reflexes, focus, and ability to handle increasing pressure.</p>
                
                <h3>Version</h3>
                <p>Version 1.1.0 (Enhanced Release 2025)</p>
                
                <h3>Credits</h3>
                <p>Developed by Daksh Hande<br>
                Sound effects generated with Web Audio API<br>
                Windows 95 theme inspired by Microsoft</p>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="showWindow('main-menu')">Back to Menu</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        <p>Mobile-Friendly</p>
    </div>

    <script>
        // Enhanced Game State with better memory management
        let gameState = {
            score: 0,
            level: 1,
            lives: 3,
            tasksCompleted: 0,
            tasksTotal: 5,
            timeRemaining: 30,
            maxTime: 30,
            gameActive: false,
            gamePaused: false,
            tasks: [],
            taskSpeed: 1500,
            spawnRate: 800,
            gameLoopInterval: null,
            timeInterval: null,
            difficulty: 'normal',
            performanceMode: false,
            taskIds: 0,
            activeAnimations: new Set(),
            gameStartTime: null
        };
        
        // High Scores with better data structure
        let highScores = [];
        let settings = {};
        
        // DOM Elements cache
        const dom = {
            windows: document.querySelectorAll('.window'),
            gameArea: document.getElementById('game-area'),
            scoreDisplay: document.getElementById('score'),
            levelDisplay: document.getElementById('level'),
            livesDisplay: document.getElementById('lives'),
            tasksCompletedDisplay: document.getElementById('tasks-completed'),
            tasksTotalDisplay: document.getElementById('tasks-total'),
            timeProgress: document.getElementById('time-progress'),
            levelDisplayMain: document.getElementById('level-display'),
            finalScoreDisplay: document.getElementById('final-score'),
            finalLevelDisplay: document.getElementById('final-level'),
            highScoresBody: document.getElementById('high-scores-body'),
            difficultySelect: document.getElementById('difficulty'),
            soundSelect: document.getElementById('sound'),
            themeSelect: document.getElementById('theme'),
            playerNameInput: document.getElementById('player-name'),
            pauseBtn: document.getElementById('pause-btn'),
            notification: document.getElementById('notification'),
            levelUpAnim: document.getElementById('level-up-anim'),
            loading: document.getElementById('loading'),
            performanceWarning: document.getElementById('performance-warning'),
            bestScoreDisplay: document.getElementById('best-score-display'),
            performanceModeCheckbox: document.getElementById('performance-mode')
        };
        
        // Audio context for sound effects
        let audioContext = null;
        let audioEnabled = false;
        
        // Initialize game
        function init() {
            try {
                // Load data from localStorage
                loadSettings();
                loadHighScores();
                updateBestScoreDisplay();
                
                // Initialize audio
                initAudio();
                
                // Set up event listeners
                setupEventListeners();
                
                // Resize handler
                resizeGameArea();
                window.addEventListener('resize', debounce(resizeGameArea, 250));
                
                // Hide loading screen after initialization
                setTimeout(() => {
                    dom.loading.classList.add('hidden');
                }, 500);
                
                // Prevent context menu on game area
                dom.gameArea.addEventListener('contextmenu', (e) => e.preventDefault());
                
                // Performance monitoring
                if ('performance' in window) {
                    performance.mark('gameInitialized');
                }
                
                console.log('Game initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Error initializing game', 'error');
            }
        }
        
        // Initialize audio system
        function initAudio() {
            try {
                if (settings.sound === 'on') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioEnabled = true;
                }
            } catch (e) {
                console.log('Audio not supported:', e);
                audioEnabled = false;
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Window controls
            document.querySelectorAll('.title-bar-button').forEach(button => {
                button.addEventListener('click', handleWindowControl);
            });
            
            // Menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Prevent default touch behavior
            document.addEventListener('touchmove', (e) => {
                if (e.target.classList.contains('game-area')) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Handle visibility change (pause when tab is hidden)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && gameState.gameActive && !gameState.gamePaused) {
                    pauseGame();
                    showNotification('Game auto-paused', 'info');
                }
            });
            
            // Prevent accidental refresh
            window.addEventListener('beforeunload', (e) => {
                if (gameState.gameActive && !gameState.gamePaused) {
                    e.preventDefault();
                    e.returnValue = 'You have an active game. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });
        }
        
        // Handle window control buttons
        function handleWindowControl(e) {
            const button = e.target;
            const window = button.closest('.window');
            const windowId = window.id;
            
            switch(button.textContent) {
                case '_':
                    // Minimize (hide)
                    window.classList.remove('active');
                    if (windowId === 'game' && gameState.gameActive && !gameState.gamePaused) {
                        pauseGame();
                    }
                    break;
                case 'â–¡':
                    // Maximize (toggle full width)
                    window.style.maxWidth = window.style.maxWidth ? '' : '95%';
                    break;
                case 'Ã—':
                    // Close
                    if (windowId === 'game' && gameState.gameActive && !gameState.gamePaused) {
                        if (confirm('Are you sure you want to quit? Your progress will be lost.')) {
                            showWindow('main-menu');
                        }
                    } else {
                        showWindow('main-menu');
                    }
                    break;
            }
        }
        
        // Window Navigation with animation
        function showWindow(windowId) {
            // Clear any ongoing animations
            clearAllTimeouts();
            
            // Update menu active state
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.toLowerCase().includes(windowId.replace('-', ' ')) || 
                    (windowId === 'main-menu' && item.textContent === 'Home')) {
                    item.classList.add('active');
                }
            });
            
            // Hide all windows
            dom.windows.forEach(window => {
                if (window.classList.contains('active')) {
                    window.classList.remove('active');
                    window.style.animation = 'none';
                    setTimeout(() => {
                        window.style.animation = '';
                    }, 10);
                }
            });
            
            // Show selected window
            const targetWindow = document.getElementById(windowId);
            if (targetWindow) {
                targetWindow.classList.add('active');
                
                // Special handling for certain windows
                switch(windowId) {
                    case 'high-scores':
                        loadHighScores();
                        break;
                    case 'game':
                        if (!gameState.gameActive) {
                            resetGame();
                        }
                        break;
                    case 'main-menu':
                        if (gameState.gameActive && !gameState.gamePaused) {
                            pauseGame();
                        }
                        updateBestScoreDisplay();
                        break;
                }
            }
        }
        
        // Game Functions
        function startGame() {
            if (gameState.gameActive) {
                if (confirm('You have an active game. Do you want to restart?')) {
                    resetGame();
                }
                return;
            }
            
            showWindow('game');
            resetGame();
            
            gameState.gameActive = true;
            gameState.gamePaused = false;
            gameState.gameStartTime = Date.now();
            dom.pauseBtn.textContent = 'Pause';
            
            // Start game loops
            startGameLoop();
            startTimer();
            
            showNotification('Game started! Good luck!', 'success');
            playSound('start');
        }
        
        function resetGame() {
            // Clear game area
            clearGameArea();
            
            // Clear intervals
            clearAllTimeouts();
            
            // Reset game state
            gameState.score = 0;
            gameState.level = 1;
            gameState.lives = 3;
            gameState.tasksCompleted = 0;
            gameState.taskIds = 0;
            gameState.activeAnimations.clear();
            
            // Update difficulty settings
            updateDifficultySettings();
            
            gameState.timeRemaining = gameState.maxTime;
            
            // Update displays
            updateDisplays();
            
            // Clear any messages
            dom.notification.classList.remove('show');
        }
        
        function clearGameArea() {
            // Use while loop for better performance
            while (dom.gameArea.firstChild) {
                dom.gameArea.removeChild(dom.gameArea.firstChild);
            }
            gameState.tasks = [];
        }
        
        function clearAllTimeouts() {
            if (gameState.gameLoopInterval) {
                clearInterval(gameState.gameLoopInterval);
                gameState.gameLoopInterval = null;
            }
            if (gameState.timeInterval) {
                clearInterval(gameState.timeInterval);
                gameState.timeInterval = null;
            }
            
            // Clear any pending timeouts
            const highestId = setTimeout(() => {}, 0);
            for (let i = 0; i < highestId; i++) {
                clearTimeout(i);
            }
        }
        
        function updateDifficultySettings() {
            const baseValues = {
                easy: { tasks: 4, time: 35, taskSpeed: 1800, spawnRate: 1000 },
                normal: { tasks: 5, time: 30, taskSpeed: 1500, spawnRate: 800 },
                hard: { tasks: 6, time: 25, taskSpeed: 1200, spawnRate: 600 },
                insane: { tasks: 8, time: 20, taskSpeed: 800, spawnRate: 400 }
            };
            
            const base = baseValues[settings.difficulty] || baseValues.normal;
            
            gameState.tasksTotal = Math.floor(base.tasks + gameState.level * (settings.difficulty === 'insane' ? 2 : 1));
            gameState.maxTime = Math.max(10, base.time - gameState.level * 2);
            gameState.taskSpeed = Math.max(400, base.taskSpeed - gameState.level * 100);
            gameState.spawnRate = Math.max(300, base.spawnRate - gameState.level * 50);
            
            // Show performance warning for high task counts
            dom.performanceWarning.style.display = gameState.tasksTotal > 15 ? 'block' : 'none';
            
            // Update display
            dom.tasksTotalDisplay.textContent = gameState.tasksTotal;
            gameState.timeRemaining = gameState.maxTime;
            updateTimeProgress();
        }
        
        function startGameLoop() {
            gameState.gameLoopInterval = setInterval(() => {
                if (gameState.gamePaused || !gameState.gameActive) return;
                
                // Spawn new task if under limit
                if (gameState.tasks.length < gameState.tasksTotal) {
                    spawnTask();
                }
                
                // Check level completion
                if (gameState.tasksCompleted >= gameState.tasksTotal) {
                    completeLevel();
                }
                
                // Performance check
                if (gameState.tasks.length > 20 && !gameState.performanceMode) {
                    showNotification('Many tasks! Consider Performance Mode', 'warning');
                }
            }, gameState.spawnRate);
        }
        
        function startTimer() {
            gameState.timeInterval = setInterval(() => {
                if (gameState.gamePaused || !gameState.gameActive) return;
                
                gameState.timeRemaining--;
                updateTimeProgress();
                
                if (gameState.timeRemaining <= 0) {
                    loseLife();
                    gameState.timeRemaining = gameState.maxTime;
                    updateTimeProgress();
                }
            }, 1000);
        }
        
        function spawnTask() {
            if (!dom.gameArea) return;
            
            const gameAreaRect = dom.gameArea.getBoundingClientRect();
            const taskSize = 60;
            const padding = 10;
            
            // Calculate position avoiding edges and other tasks
            let x, y;
            let attempts = 0;
            const maxAttempts = 20;
            
            do {
                x = Math.floor(Math.random() * (gameAreaRect.width - taskSize - padding * 2)) + padding;
                y = Math.floor(Math.random() * (gameAreaRect.height - taskSize - padding * 2)) + padding;
                attempts++;
            } while (isOverlapping(x, y, taskSize) && attempts < maxAttempts);
            
            if (attempts >= maxAttempts) {
                console.warn('Could not find non-overlapping position');
                return;
            }
            
            // Create task with unique ID
            const taskId = `task_${gameState.taskIds++}`;
            const task = document.createElement('div');
            task.className = 'task';
            task.id = taskId;
            task.style.left = `${x}px`;
            task.style.top = `${y}px`;
            task.textContent = Math.floor(Math.random() * 9) + 1;
            task.dataset.created = Date.now();
            
            // Add touch/click handler
            const handleComplete = () => completeTask(taskId);
            task.addEventListener('click', handleComplete);
            task.addEventListener('touchstart', handleComplete, { passive: true });
            
            dom.gameArea.appendChild(task);
            gameState.tasks.push({ element: task, id: taskId, timeout: null });
            
            // Set removal timeout
            const timeoutId = setTimeout(() => {
                const taskIndex = gameState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    const taskObj = gameState.tasks[taskIndex];
                    if (taskObj.element.parentNode && !taskObj.element.classList.contains('completed')) {
                        taskObj.element.classList.add('failed');
                        
                        setTimeout(() => {
                            if (taskObj.element.parentNode) {
                                dom.gameArea.removeChild(taskObj.element);
                                gameState.tasks.splice(taskIndex, 1);
                                loseLife();
                            }
                        }, gameState.performanceMode ? 0 : 300);
                    }
                    gameState.tasks.splice(taskIndex, 1);
                }
            }, gameState.taskSpeed);
            
            // Store timeout ID for cleanup
            const taskIndex = gameState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                gameState.tasks[taskIndex].timeout = timeoutId;
            }
        }
        
        function isOverlapping(x, y, size) {
            const padding = 5;
            for (const task of gameState.tasks) {
                const rect = task.element.getBoundingClientRect();
                const gameAreaRect = dom.gameArea.getBoundingClientRect();
                
                const taskX = rect.left - gameAreaRect.left;
                const taskY = rect.top - gameAreaRect.top;
                
                if (!(x + size + padding < taskX || 
                      x > taskX + size + padding || 
                      y + size + padding < taskY || 
                      y > taskY + size + padding)) {
                    return true;
                }
            }
            return false;
        }
        
        function completeTask(taskId) {
            if (gameState.gamePaused) return;
            
            const taskIndex = gameState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const taskObj = gameState.tasks[taskIndex];
            const taskElement = taskObj.element;
            
            if (taskElement.classList.contains('completed') || 
                taskElement.classList.contains('failed')) return;
            
            // Clear the removal timeout
            if (taskObj.timeout) {
                clearTimeout(taskObj.timeout);
            }
            
            // Mark as completed
            taskElement.classList.add('completed');
            taskElement.textContent = 'âœ“';
            
            // Update game state
            gameState.tasksCompleted++;
            gameState.score += 10 * gameState.level;
            
            // Update displays
            updateDisplays();
            
            // Remove task after animation
            setTimeout(() => {
                if (taskElement.parentNode) {
                    dom.gameArea.removeChild(taskElement);
                    gameState.tasks.splice(taskIndex, 1);
                }
            }, gameState.performanceMode ? 0 : 500);
            
            // Play sound
            playSound('click');
        }
        
        function completeLevel() {
            // Calculate bonuses
            const timeBonus = Math.floor(gameState.timeRemaining) * gameState.level;
            const levelBonus = 100 * gameState.level;
            gameState.score += timeBonus + levelBonus;
            
            // Advance level
            gameState.level++;
            gameState.tasksCompleted = 0;
            
            // Update difficulty
            updateDifficultySettings();
            
            // Clear existing tasks
            clearGameArea();
            
            // Update displays
            updateDisplays();
            
            // Show level up animation
            if (!gameState.performanceMode) {
                dom.levelUpAnim.style.display = 'block';
                setTimeout(() => {
                    dom.levelUpAnim.style.display = 'none';
                }, 1000);
            }
            
            showNotification(`Level Complete! +${timeBonus + levelBonus} points`, 'success');
            playSound('levelup');
        }
        
        function loseLife() {
            gameState.lives--;
            updateDisplays();
            
            if (gameState.lives <= 0) {
                gameOver();
            } else {
                showNotification(`Task missed! ${gameState.lives} ${gameState.lives === 1 ? 'life' : 'lives'} remaining`, 'error');
                playSound('error');
            }
        }
        
        function gameOver() {
            gameState.gameActive = false;
            gameState.gamePaused = false;
            
            // Clear intervals
            clearAllTimeouts();
            
            // Calculate play time
            const playTime = gameState.gameStartTime ? Math.floor((Date.now() - gameState.gameStartTime) / 1000) : 0;
            
            // Update final score display
            dom.finalScoreDisplay.textContent = gameState.score;
            dom.finalLevelDisplay.textContent = gameState.level;
            
            // Auto-fill player name if available
            const savedName = localStorage.getItem('playerName');
            if (savedName) {
                dom.playerNameInput.value = savedName;
            }
            
            // Show game over screen
            showWindow('game-over');
            
            // Play sound
            playSound('gameover');
            
            console.log(`Game over - Score: ${gameState.score}, Level: ${gameState.level}, Time: ${playTime}s`);
        }
        
        function pauseGame() {
            if (!gameState.gameActive) return;
            
            gameState.gamePaused = !gameState.gamePaused;
            
            if (gameState.gamePaused) {
                dom.pauseBtn.textContent = 'Resume';
                showNotification('Game Paused', 'info');
            } else {
                dom.pauseBtn.textContent = 'Pause';
                showNotification('Game Resumed', 'info');
            }
        }
        
        function updateDisplays() {
            dom.scoreDisplay.textContent = gameState.score;
            dom.levelDisplay.textContent = gameState.level;
            dom.levelDisplayMain.textContent = gameState.level;
            dom.livesDisplay.textContent = gameState.lives;
            dom.tasksCompletedDisplay.textContent = gameState.tasksCompleted;
            dom.tasksTotalDisplay.textContent = gameState.tasksTotal;
            updateTimeProgress();
        }
        
        function updateTimeProgress() {
            const percent = (gameState.timeRemaining / gameState.maxTime) * 100;
            dom.timeProgress.style.width = `${percent}%`;
            
            // Color coding
            if (percent < 20) {
                dom.timeProgress.style.backgroundColor = '#ff0000';
            } else if (percent < 40) {
                dom.timeProgress.style.backgroundColor = '#ff8000';
            } else if (percent < 60) {
                dom.timeProgress.style.backgroundColor = '#ffff00';
            } else {
                dom.timeProgress.style.backgroundColor = '#000080';
            }
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            const colors = {
                info: '#000080',
                success: '#00c000',
                warning: '#c0c000',
                error: '#c00000'
            };
            
            dom.notification.textContent = message;
            dom.notification.style.backgroundColor = colors[type] || colors.info;
            dom.notification.classList.add('show');
            
            setTimeout(() => {
                dom.notification.classList.remove('show');
            }, 3000);
        }
        
        // Sound system
        function playSound(type) {
            if (!audioEnabled || settings.sound !== 'on') return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'click':
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.1);
                        break;
                        
                    case 'error':
                        oscillator.frequency.value = 300;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                        
                    case 'levelup':
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.5);
                        break;
                        
                    case 'gameover':
                        oscillator.frequency.setValueAtTime(392.00, audioContext.currentTime); // G4
                        oscillator.frequency.setValueAtTime(311.13, audioContext.currentTime + 0.2); // D#4
                        oscillator.frequency.setValueAtTime(261.63, audioContext.currentTime + 0.4); // C4
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.8);
                        break;
                }
            } catch (e) {
                console.log('Sound error:', e);
            }
        }
        
        // High Scores Functions
        function saveScore() {
            const playerName = dom.playerNameInput.value.trim() || 'Anonymous';
            if (playerName) {
                localStorage.setItem('playerName', playerName);
            }
            
            const scoreObj = {
                name: playerName.substring(0, 20),
                score: gameState.score,
                level: gameState.level,
                date: new Date().toLocaleDateString(),
                time: new Date().toISOString()
            };
            
            highScores.push(scoreObj);
            highScores.sort((a, b) => b.score - a.score || new Date(b.time) - new Date(a.time));
            highScores = highScores.slice(0, 10);
            
            localStorage.setItem('productivityHighScores', JSON.stringify(highScores));
            loadHighScores();
            
            const rank = highScores.findIndex(s => s.score === gameState.score && s.name === playerName) + 1;
            showNotification(`Score saved! Rank: #${rank}`, 'success');
            
            showWindow('main-menu');
        }
        
        function loadHighScores() {
            const saved = localStorage.getItem('productivityHighScores');
            highScores = saved ? JSON.parse(saved) : [];
            
            dom.highScoresBody.innerHTML = '';
            
            if (highScores.length === 0) {
                dom.highScoresBody.innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; padding: 20px;">No scores yet. Be the first!</td></tr>';
                return;
            }
            
            highScores.forEach((score, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${escapeHtml(score.name)}</td>
                    <td>${score.score.toLocaleString()}</td>
                    <td>${score.level}</td>
                    <td>${score.date}</td>
                `;
                dom.highScoresBody.appendChild(row);
            });
        }
        
        function clearScores() {
            if (confirm('Are you sure you want to clear all high scores? This cannot be undone.')) {
                highScores = [];
                localStorage.removeItem('productivityHighScores');
                loadHighScores();
                showNotification('High scores cleared', 'info');
            }
        }
        
        function updateBestScoreDisplay() {
            const bestScore = highScores.length > 0 ? Math.max(...highScores.map(s => s.score)) : 0;
            dom.bestScoreDisplay.textContent = bestScore.toLocaleString();
        }
        
        // Settings Functions
        function loadSettings() {
            const saved = localStorage.getItem('gameSettings');
            settings = saved ? JSON.parse(saved) : {
                difficulty: 'normal',
                sound: 'on',
                theme: 'windows95',
                performanceMode: false
            };
            
            dom.difficultySelect.value = settings.difficulty;
            dom.soundSelect.value = settings.sound;
            dom.themeSelect.value = settings.theme;
            dom.performanceModeCheckbox.checked = settings.performanceMode || false;
            gameState.performanceMode = settings.performanceMode || false;
        }
        
        function saveSettings() {
            settings.difficulty = dom.difficultySelect.value;
            settings.sound = dom.soundSelect.value;
            settings.theme = dom.themeSelect.value;
            settings.performanceMode = dom.performanceModeCheckbox.checked;
            gameState.performanceMode = settings.performanceMode;
            
            localStorage.setItem('gameSettings', JSON.stringify(settings));
            
            // Update audio
            audioEnabled = settings.sound === 'on';
            if (audioEnabled && !audioContext) {
                initAudio();
            }
            
            showNotification('Settings saved successfully', 'success');
            setTimeout(() => showWindow('main-menu'), 1000);
        }
        
        function resetToDefaults() {
            if (confirm('Reset all settings to defaults?')) {
                localStorage.removeItem('gameSettings');
                loadSettings();
                showNotification('Settings reset to defaults', 'info');
            }
        }
        
        // Utility Functions
        function resizeGameArea() {
            const windowHeight = window.innerHeight;
            const maxHeight = Math.min(300, windowHeight * 0.45);
            
            if (dom.gameArea) {
                dom.gameArea.style.height = `${maxHeight}px`;
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize game when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
